**Чек лист быстрой проверки системы** 

- [x] Настроить параллелизм в MS SQL Server.
- [x] Проверить, сколько ядер используют MS SQL Server и 1С.
- [x] Проверить настройку Turbo Boost.
- [x] Включить механизм версионирования в MS SQL для 8.2.
- [x] Проверить выполнение регламентных операций СУБД и 1С.
- [x] Использовать таблицы итогов регистров сведений.
- [x] Убрать лишнее.

## Настроить параллелизм в MS SQL Server

Оставить настройку Max degree of parallelism = 0, но установить настройку Cost threshold for parallelism = 30.

Такая настройка означает, что MS SQL будет самостоятельно решать, сколько потоков использовать для выполнения одного запроса, но распараллеливание будет включаться, только если стоимость плана запроса будет выше 30.

Стоимость плана измеряется в неких условных единицах и отражает, насколько «тяжелым» является запрос для исполнения. Чем выше стоимость, тем сильнее запрос нагружает систему. При настройках по умолчанию параллельность включается, если стоимость плана выше 5. Значение 30 — не какая-то сакральная величина: просто, с точки зрения автора, оно подходит для большинства систем.

Благодаря такой настройке параллельность будет использоваться только для действительно сложных запросов. Запросы полегче продолжат выполняться в один поток — им распараллеливание все равно не дает заметного ускорения.

Следует отметить, что это решение не освобождает от необходимости оптимизировать «тяжелые» запросы, но оно хотя бы не мешает другим операциям выполняться быстро.
<details>  
  <summary>Установка cost threshold for parallelism</summary>

``` SQL 
  EXEC sys.sp_configure N'show advanced options', N'1' RECONFIGURE WITH OVERRIDE
  GO
  EXEC sys.sp_configure N'cost threshold for parallelism', N'30'
  GO
  RECONFIGURE WITH OVERRIDE
  GO
  EXEC sys.sp_configure N'show advanced options', N'0' RECONFIGURE WITH OVERRIDE
  GO

```
</details>

!!! warning
    - [x] Сбросить статистику после изменения настроек
    ``` sql
    DBCC SQLPERF (N'sys.dm_os_wait_stats', CLEAR);
    GO
    ```

!!! info "Источники"
    [gilev.ru "CXPACKET в топе по ожиданиям на MSSSQL"](http://www.gilev.ru/forum/viewtopic.php?f=18&t=1201&sid=a2f93a47336babab8f21cdf92d9c23fe)

### Несколько ситуаций, при которых не стоит отключать распараллеливание:

- Описанный в документации случай, когда один запрос при распараллеливании замедляет всех — не самый распространенный паттерн. Чаще неоптимальный запрос выполняется медленно в один поток, хотя мог бы выполняться гораздо быстрее в несколько потоков, при этом несильно загружая процессор.
- Если отключить распараллеливание на уровне сервера, тогда и регламентные операции по умолчанию тоже будут выполняться в один поток. Чтобы этого избежать, нужно указывать настройку распараллеливания (MAXDOP = 0) для регламентного задания дефрагментации/реиндексации, чего многие, к сожалению, не делают.
- Новый механизм реструктуризации работает гораздо быстрее, если включено распараллеливание. Об этом сказано и в документации. Там же предлагается каждый раз перед реструктуризацией включать параллельность, а после обновления — отключать. Но все мы люди, и часто разработчики просто забывают установить параметр в нужное значение. В итоге реструктуризация больших таблиц даже с новым механизмом идет медленно.
- Ожидания CXPACKET зачастую интерпретируются неправильно. Их наличие далеко не всегда говорит о проблемах с распараллеливанием. Если хочется больше узнать об этом, подробности Вы найдете в статье [Troubleshooting the CXPACKET wait type in SQL Server](https://www.sqlshack.com/troubleshooting-the-cxpacket-wait-type-in-sql-server/).


## Проверить, сколько ядер используют MS SQL Server и 1С

### MS SQL Server 
Чтобы узнать, сколько логических процессоров (ядра, в том числе и гиперпоточные) задействует Ваш экземпляр MS SQL, следует выполнить следующий запрос

<details>  
  <summary>Количество задействованых логических процессоров</summary>

``` SQL 
select * from sys.dm_os_schedulers where status = ‘VISIBLE ONLINE’ and is_online = 1
```
</details>

### 1C:Предприятие

!!! abstract

    Важно помнить, что у 1С тоже есть ограничения по количеству используемых ядер. Например, версия ПРОФ может использовать только 12 ядер и, если поставить ее на 24-ядерный сервер, то половина процессорных мощностей будет простаивать.
    Если на сервере больше 12 ядер и Вы хотите, чтобы 1С использовала их все, необходимо приобрести версию КОРП.
